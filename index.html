<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOTOCA WebRadio - Exp√©rience Musicale Unique</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #121212; color: #ffffff; padding: 20px; max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding: 20px 0; border-bottom: 1px solid #333; }
        h1 { font-size: 2.5em; margin-bottom: 10px; color: #5c67f2; }
        .radio-info { max-width: 600px; margin: 0 auto 30px auto; text-align: center; line-height: 1.6; color: #aaa; }
        .category-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .category-button { background-color: #333; color: white; border: none; border-radius: 20px; padding: 12px 25px; font-size: 1em; cursor: pointer; transition: all 0.3s ease; }
        .category-button:hover { background-color: #5c67f2; transform: translateY(-2px); }
        .category-button.active { background-color: #5c67f2; }
        .category-button:focus { outline: 2px solid #5c67f2; outline-offset: 2px; }
        .subcategory-container { display: none; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 25px; }
        .subcategory-button { background-color: #444; color: white; border: none; border-radius: 20px; padding: 8px 18px; font-size: 0.9em; cursor: pointer; transition: all 0.3s ease; }
        .subcategory-button:hover { background-color: #5c67f2; transform: translateY(-2px); }
        .subcategory-button.active { background-color: #5c67f2; }
        .subcategory-button:focus { outline: 2px solid #5c67f2; outline-offset: 2px; }
        .loading-message { text-align: center; padding: 60px 20px; font-style: italic; color: #888; min-height: 240px; display: flex; justify-content: center; align-items: center;}
        .iframe-container { width: 100%; margin-bottom: 20px; background-color: #222; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); min-height: 240px; position: relative; }
        #suno-iframe { display: block; border: none; width: 100%; height: 240px; transition: opacity 0.3s ease; }
        .controls { display: flex; justify-content: center; gap: 15px; margin: 25px 0; }
        .button-next, .button-pause, .button-history { display: inline-block; background-color: #5c67f2; color: white; padding: 12px 24px; border: none; border-radius: 25px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(92, 103, 242, 0.3); }
        .button-next:hover, .button-pause:hover, .button-history:hover { background-color: #4a54cc; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(92, 103, 242, 0.4); }
        .button-next:focus, .button-pause:focus, .button-history:focus { outline: 2px solid #5c67f2; outline-offset: 2px; }
        .history-container { margin-top: 30px; padding: 15px; background-color: #222; border-radius: 8px; display: none; }
        .history-container h3 { margin-bottom: 15px; color: #ccc; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .history-list { list-style-type: none; padding-left: 0; }
        .history-list li { padding: 8px 0; border-bottom: 1px solid #333; color: #aaa; }
        .history-list li:last-child { border-bottom: none; }
        .support-section { text-align: center; margin: 40px 0; padding: 20px; background-color: rgba(92, 103, 242, 0.1); border-radius: 8px; border: 1px solid rgba(92, 103, 242, 0.3); }
        .support-title { font-size: 1.5em; color: #5c67f2; margin-bottom: 15px; }
        .support-text { margin-bottom: 20px; line-height: 1.5; color: #aaa; }
        .support-buttons { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .support-button { display: inline-block; background-color: #f28c31; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; transition: all 0.3s ease; }
        .support-button:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(242, 140, 49, 0.4); }
        .paypal-button { background-color: #0070ba; }
        .attribution { margin-top: 40px; padding-top: 20px; font-size: 0.8em; color: #666; text-align: center; border-top: 1px solid #333; }
        .attribution a { color: #5c67f2; text-decoration: none; }
        .attribution a:hover { text-decoration: underline; }
        .now-playing { text-align: center; margin-top: 15px; font-size: 0.9em; color: #aaa; min-height: 1.2em; }
        #initial-play-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 20px; background-color: rgba(34, 34, 34, 0.8); border-radius: 8px; cursor: pointer; transition: opacity 0.3s ease-out; }
        #initial-play-overlay.hidden { opacity: 0; pointer-events: none; }
        #start-radio-button { background-color: #5c67f2; color: white; padding: 15px 30px; border: none; border-radius: 30px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin-top: 15px; }
        #start-radio-button:hover { background-color: #4a54cc; transform: scale(1.05); }
        #start-radio-button:focus { outline: 2px solid #5c67f2; outline-offset: 2px; }
        .overlay-icon { font-size: 3em; color: #5c67f2; margin-bottom: 10px; }
        .overlay-text { font-size: 0.9em; color: #ccc; margin-top: 15px; }
        .progress-bar { height: 5px; background: #5c67f2; width: 0; transition: width linear; position: absolute; top: 0; left: 0; }
        @media (max-width: 600px) { 
            body { padding: 10px; } 
            h1 { font-size: 1.8em; } 
            .controls { flex-direction: column; } 
            .category-buttons { gap: 10px; } 
            .category-button { padding: 10px 20px; font-size: 0.9em; } 
            .subcategory-button { padding: 6px 14px; font-size: 0.8em; } 
            #start-radio-button { padding: 12px 24px; font-size: 1em;} 
            .overlay-icon { font-size: 2.5em;} 
        }
    </style>
</head>
<body>
    <header>
        <h1>SOTOCA WebRadio</h1>
        <p class="radio-info">Une exp√©rience musicale unique √† chaque visite ....</p>
    </header>

    <div class="category-buttons" role="tablist">
        <button class="category-button active" data-category="ambiance" role="tab" aria-selected="true" aria-controls="subcategory-ambiance">Ambiance</button>
        <button class="category-button" data-category="moment" role="tab" aria-selected="false" aria-controls="subcategory-moment">Moment</button>
        <button class="category-button" data-category="intention" role="tab" aria-selected="false" aria-controls="subcategory-intention">Intention</button>
    </div>

    <div class="subcategory-container" id="subcategory-ambiance" role="tabpanel" aria-labelledby="ambiance-tab">
        <button class="subcategory-button active" data-subcategory="Calme">Calme</button>
        <button class="subcategory-button" data-subcategory="√ânergique">√ânergique</button>
        <button class="subcategory-button" data-subcategory="M√©lancolique">M√©lancolique</button>
        <button class="subcategory-button" data-subcategory="M√©ditative">M√©ditative</button>
        <button class="subcategory-button" data-subcategory="Joyeuse">Joyeuse</button>
    </div>
    <div class="subcategory-container" id="subcategory-moment" role="tabpanel" aria-labelledby="moment-tab">
        <button class="subcategory-button active" data-subcategory="Matin">Matin</button>
        <button class="subcategory-button" data-subcategory="Midi">Midi</button>
        <button class="subcategory-button" data-subcategory="Apr√®s-midi">Apr√®s-midi</button>
        <button class="subcategory-button" data-subcategory="Soir">Soir</button>
        <button class="subcategory-button" data-subcategory="Nuit">Nuit</button>
    </div>
    <div class="subcategory-container" id="subcategory-intention" role="tabpanel" aria-labelledby="intention-tab">
        <button class="subcategory-button active" data-subcategory="D√©tente">D√©tente</button>
        <button class="subcategory-button" data-subcategory="Motivation">Motivation</button>
        <button class="subcategory-button" data-subcategory="M√©ditation">M√©ditation</button>
        <button class="subcategory-button" data-subcategory="R√©flexion">R√©flexion</button>
        <button class="subcategory-button" data-subcategory="Voyage">Voyage</button>
    </div>

    <div class="iframe-container" id="player-container">
        <div id="initial-play-overlay">
            <span class="overlay-icon">üéµ</span>
            <button id="start-radio-button" aria-label="Lancer la radio SOTOCA">Lancer la Radio</button>
            <p class="overlay-text">(Cliquez pour d√©marrer)</p>
        </div>
        <div id="iframe-target"></div>
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="now-playing">
        <p id="now-playing-text"></p>
    </div>

    <div class="controls">
        <button class="button-next" id="next-track">Morceau suivant</button>
        <button class="button-pause" id="pause-track">Pause</button>
        <button class="button-history" id="toggle-history">Voir l'historique</button>
    </div>

    <div class="history-container" id="history-container">
        <h3>Historique de lecture</h3>
        <ul class="history-list" id="history-list"></ul>
    </div>

    <div class="support-section">
        <h2 class="support-title">SOUTENIR SOTOCA WEBRADIO</h2>
        <p class="support-text">Cette radio est sans publicit√© et enti√®rement gratuite. Votre soutien nous permet de continuer √† offrir une exp√©rience musicale unique et sans interruption.</p>
        <div class="support-buttons">
            <a href="https://www.paypal.com/donate" target="_blank" class="support-button paypal-button">Faire un don via PayPal</a>
            <a href="https://www.tipeee.com" target="_blank" class="support-button">Nous soutenir sur Tipeee</a>
        </div>
    </div>

    <div class="attribution">
        <p>Tous les morceaux sont fournis par <a href="https://suno.com" target="_blank">Suno</a> sous licence libre. Cette radio est un projet ind√©pendant et n'est pas affili√©e √† Suno.</p>
    </div>

    <script>
        // Liste des pistes sans doublons
        const sunoTracks = [
            { "id": "1dba28fb-3dfa-41b6-b438-cc81b587d40c", "title": "Saudade", "artist": "GROOVEBOT", "ambiance": "M√©lancolique", "moment": "Soir", "intention": "R√©flexion", "duration": 219 },
            { "id": "2160a428-d7c4-4892-b250-9a739a60e475", "title": "Fuja de quem n√£o quer te perder mas n√£o sabe te amar", "artist": "Roberto na √Årea", "ambiance": "√ânergique", "moment": "Midi", "intention": "Motivation", "duration": 157 },
            { "id": "b4661e87-97c3-4b6e-87ca-f31f47ac40ef", "title": "Eu N√£o Ando Sumido", "artist": "Roberto na √Årea", "ambiance": "Calme", "moment": "Soir", "intention": "D√©tente", "duration": 148 },
            { "id": "533b9834-52a5-4100-8d05-9ef605a4e715", "title": "Blues in the light of dawn", "artist": "GROOVEBOT", "ambiance": "M√©lancolique", "moment": "Matin", "intention": "R√©flexion", "duration": 183 }
        ];

        // Variables globales
        let currentCategory = "ambiance";
        let currentSubcategory = "Calme";
        let currentTrackId = null;
        let nextTrackTimer = null;
        let radioHasStarted = false;
        let isPaused = false;
        let isLoading = false;
        let startTime = null;

        // √âl√©ments du DOM
        const categoryButtonsContainer = document.querySelector('.category-buttons');
        const subcategoryContainers = document.querySelectorAll('.subcategory-container');
        const playerContainer = document.getElementById('player-container');
        const initialOverlay = document.getElementById('initial-play-overlay');
        const startButton = document.getElementById('start-radio-button');
        const iframeTarget = document.getElementById('iframe-target');
        const nowPlayingText = document.getElementById('now-playing-text');
        const nextTrackButton = document.getElementById('next-track');
        const pauseButton = document.getElementById('pause-track');
        const toggleHistoryButton = document.getElementById('toggle-history');
        const historyContainer = document.getElementById('history-container');
        const historyList = document.getElementById('history-list');
        const progressBar = document.getElementById('progress-bar');

        // Fonctions Utilitaires
        function getPlayHistory() {
            try {
                const history = localStorage.getItem('sunoRadioHistory');
                return history ? JSON.parse(history) : [];
            } catch (e) {
                console.error("Erreur lecture historique:", e);
                return [];
            }
        }

        function updatePlayHistory(trackId) {
            if (!trackId) return;
            let history = getPlayHistory();
            const track = sunoTracks.find(t => t.id === trackId);
            if (track) {
                nowPlayingText.textContent = `En cours: ${track.title} par ${track.artist}`;
                if (history.length === 0 || history[0].id !== trackId) {
                    history.unshift({
                        id: trackId,
                        title: track.title,
                        artist: track.artist,
                        category: `${currentCategory}: ${currentSubcategory}`,
                        timestamp: new Date().toISOString()
                    });
                    if (history.length > 15) history = history.slice(0, 15);
                    try {
                        localStorage.setItem('sunoRadioHistory', JSON.stringify(history));
                        updateHistoryDisplay();
                    } catch (e) {
                        console.error("Erreur sauvegarde historique:", e);
                    }
                }
            }
        }

        function updateHistoryDisplay() {
            if (historyContainer.style.display !== 'block') return;
            const fragment = document.createDocumentFragment();
            const history = getPlayHistory();
            if (history.length === 0) {
                const li = document.createElement('li');
                li.textContent = "Aucun morceau dans l'historique.";
                fragment.appendChild(li);
            } else {
                history.forEach(item => {
                    const li = document.createElement('li');
                    const time = new Date(item.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    li.textContent = `${item.title} par ${item.artist} (${item.category}) - ${time}`;
                    fragment.appendChild(li);
                });
            }
            historyList.innerHTML = '';
            historyList.appendChild(fragment);
        }

        function getTracksByCategoryAndSubcategory(category, subcategory) {
            return sunoTracks.filter(track => track[category] === subcategory);
        }

        function selectRandomTrack() {
            const history = getPlayHistory();
            let availableTracks = getTracksByCategoryAndSubcategory(currentCategory, currentSubcategory);
            if (availableTracks.length === 0) {
                console.warn(`Aucun morceau pour ${currentCategory}: ${currentSubcategory}.`);
                return sunoTracks[Math.floor(Math.random() * sunoTracks.length)];
            }
            if (history.length > 0 && availableTracks.length > 2) {
                const recentTrackIds = [...new Set(history.slice(0, 2).map(item => item.id))];
                const filteredTracks = availableTracks.filter(track => !recentTrackIds.includes(track.id));
                if (filteredTracks.length > 0) availableTracks = filteredTracks;
            }
            return availableTracks[Math.floor(Math.random() * availableTracks.length)];
        }

        function updateCategoryButtons() {
            const buttons = categoryButtonsContainer.querySelectorAll('.category-button');
            buttons.forEach(button => {
                button.classList.toggle('active', button.dataset.category === currentCategory);
                button.setAttribute('aria-selected', button.dataset.category === currentCategory);
            });
            subcategoryContainers.forEach(container => {
                container.style.display = container.id === `subcategory-${currentCategory}` ? 'flex' : 'none';
            });
            updateSubcategoryButtons();
        }

        function updateSubcategoryButtons() {
            const activeContainer = document.getElementById(`subcategory-${currentCategory}`);
            if (activeContainer) {
                const buttons = activeContainer.querySelectorAll('.subcategory-button');
                buttons.forEach(button => {
                    button.classList.toggle('active', button.dataset.subcategory === currentSubcategory);
                });
            }
        }

        function updateProgress(track) {
            progressBar.style.width = '0%';
            if (track.duration) {
                startTime = Date.now();
                const interval = setInterval(() => {
                    if (isPaused) return;
                    const elapsed = (Date.now() - startTime) / 1000;
                    progressBar.style.width = `${Math.min((elapsed / track.duration) * 100, 100)}%`;
                }, 1000);
                setTimeout(() => clearInterval(interval), track.duration * 1000);
            }
        }

        // Fonctions principales
        function loadTrack(track) {
            if (!track || !track.id) {
                iframeTarget.innerHTML = '<p class="loading-message">Erreur : Piste invalide.</p>';
                nowPlayingText.textContent = 'Erreur de chargement';
                return;
            }
            currentTrackId = track.id;
            if (nextTrackTimer) clearTimeout(nextTrackTimer);
            const iframe = document.createElement('iframe');
            iframe.id = 'suno-iframe';
            iframe.src = `https://suno.com/embed/${track.id}?autoplay=true`;
            iframe.title = `Lecteur Suno pour ${track.title}`;
            iframe.allow = 'autoplay';
            iframe.onerror = () => {
                iframeTarget.innerHTML = '<p class="loading-message">Erreur : Impossible de charger ce morceau. Passage au suivant...</p>';
                setTimeout(loadNextTrack, 2000);
            };
            iframeTarget.innerHTML = '';
            iframeTarget.appendChild(iframe);
            updatePlayHistory(track.id);
            updateProgress(track);
            if (track.duration) {
                nextTrackTimer = setTimeout(loadNextTrack, track.duration * 1000 + 3000);
            }
        }

        function loadNextTrack() {
            if (!radioHasStarted || isPaused || isLoading) return;
            isLoading = true;
            iframeTarget.innerHTML = '<p class="loading-message">Chargement du prochain morceau...</p>';
            nowPlayingText.textContent = 'S√©lection en cours...';
            setTimeout(() => {
                const trackToLoad = selectRandomTrack();
                if (trackToLoad) loadTrack(trackToLoad);
                else {
                    iframeTarget.innerHTML = '<p class="loading-message">Erreur : Aucun morceau trouv√©.</p>';
                    nowPlayingText.textContent = 'Erreur de s√©lection';
                }
                isLoading = false;
            }, 100);
        }

        function startRadioFirstTime() {
            if (radioHasStarted) return;
            radioHasStarted = true;
            initialOverlay.classList.add('hidden');
            loadNextTrack();
        }

        // √âcouteurs d'√©v√©nements
        function setupEventListeners() {
            categoryButtonsContainer.addEventListener('click', (event) => {
                const button = event.target.closest('.category-button');
                if (button) {
                    currentCategory = button.dataset.category;
                    currentSubcategory = document.querySelector(`#subcategory-${currentCategory} .subcategory-button.active`).dataset.subcategory;
                    updateCategoryButtons();
                    if (radioHasStarted) loadNextTrack();
                    else startRadioFirstTime();
                }
            });

            subcategoryContainers.forEach(container => {
                container.addEventListener('click', (event) => {
                    const button = event.target.closest('.subcategory-button');
                    if (button) {
                        currentSubcategory = button.dataset.subcategory;
                        updateSubcategoryButtons();
                        if (radioHasStarted) loadNextTrack();
                        else startRadioFirstTime();
                    }
                });
            });

            initialOverlay.addEventListener('click', startRadioFirstTime);
            nextTrackButton.addEventListener('click', () => {
                if (isLoading) return;
                if (!radioHasStarted) startRadioFirstTime();
                else loadNextTrack();
            });

            pauseButton.addEventListener('click', () => {
                if (!radioHasStarted) return;
                isPaused = !isPaused;
                if (isPaused) {
                    clearTimeout(nextTrackTimer);
                    iframeTarget.style.opacity = '0.5';
                } else {
                    const track = sunoTracks.find(t => t.id === currentTrackId);
                    if (track) {
                        const elapsed = (Date.now() - startTime) / 1000;
                        const remaining = Math.max(track.duration - elapsed, 0);
                        nextTrackTimer = setTimeout(loadNextTrack, remaining * 1000 + 3000);
                    }
                    iframeTarget.style.opacity = '1';
                }
                pauseButton.textContent = isPaused ? 'Reprendre' : 'Pause';
            });

            toggleHistoryButton.addEventListener('click', function() {
                const isVisible = historyContainer.style.display === 'block';
                historyContainer.style.display = isVisible ? 'none' : 'block';
                this.textContent = isVisible ? "Voir l'historique" : "Cacher l'historique";
                if (!isVisible) updateHistoryDisplay();
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            if (!sunoTracks || sunoTracks.length === 0) {
                initialOverlay.innerHTML = '<p class="loading-message" style="color: red;">Erreur: Liste de morceaux vide !</p>';
                return;
            }
            updateCategoryButtons();
            updateHistoryDisplay();
            setupEventListeners();
        });
    </script>
</body>
</html>
